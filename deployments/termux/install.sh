#!/data/data/com.termux/files/usr/bin/bash

# Ø£Ù„ÙˆØ§Ù† Ù„Ù„ØªÙ†Ø³ÙŠÙ‚
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

clear
echo -e "${BLUE}"
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                                                          â•‘"
echo "â•‘  â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— â•‘"
echo "â•‘  â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘ â•‘"
echo "â•‘  â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘ â•‘"
echo "â•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘ â•‘"
echo "â•‘  â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘ â•‘"
echo "â•‘  â•šâ•â•     â•šâ•â•â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â• â•šâ•â•â•â•šâ•â•â• â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•â• â•‘"
echo "â•‘                                                          â•‘"
echo "â•‘            H U B   F A C T O R I E S   v3.0.0            â•‘"
echo "â•‘                                                          â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "${NC}"
echo "ðŸ“± ØªØ«Ø¨ÙŠØª Marwan Hub Ø¹Ù„Ù‰ Termux"
echo "ðŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: $(date)"
echo "ðŸ“¦ Ø§Ù„Ø¥ØµØ¯Ø§Ø±: v3.0.0"
echo ""

# Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
echo -e "${YELLOW}[1/8] Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ø¯ÙŠØ«Ø§Øª Termux...${NC}"
pkg update -y && pkg upgrade -y

# ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
echo -e "${YELLOW}[2/8] ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©...${NC}"
pkg install -y git curl wget rust cargo make cmake clang \
    openssl openssl-tool openssl-dev postgresql redis \
    nodejs python python-pip libxml2 libxslt

# Ø¥Ù†Ø´Ø§Ø¡ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
echo -e "${YELLOW}[3/8] Ø¥Ù†Ø´Ø§Ø¡ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹...${NC}"
cd ~
if [ -d "marwan-hub-factories-v3.0.0" ]; then
    echo -e "${BLUE}âš ï¸  Ø§Ù„Ù…Ø¬Ù„Ø¯ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...${NC}"
    cd marwan-hub-factories-v3.0.0
    git pull origin main
else
    git clone https://github.com/marwan-hub/factories.git marwan-hub-factories-v3.0.0
    cd marwan-hub-factories-v3.0.0
fi

# Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
echo -e "${YELLOW}[4/8] Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹...${NC}"
cargo build --release

# Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø±Ù…Ø²ÙŠØ©
echo -e "${YELLOW}[5/8] Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø±Ù…Ø²ÙŠØ©...${NC}"
if [ ! -f "/data/data/com.termux/files/usr/bin/marwan-hub" ]; then
    ln -s ~/marwan-hub-factories-v3.0.0/target/release/marwan-hub /data/data/com.termux/files/usr/bin/marwan-hub
    chmod +x /data/data/com.termux/files/usr/bin/marwan-hub
fi

# Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
echo -e "${YELLOW}[6/8] Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...${NC}"
mkdir -p ~/.marwan-hub/{config,logs,data,templates,backups}
cp -r templates/* ~/.marwan-hub/templates/ 2>/dev/null || true

# ØªØ«Ø¨ÙŠØª Ø§Ù„Ø®Ø¯Ù…Ø§Øª
echo -e "${YELLOW}[7/8] ØªØ«Ø¨ÙŠØª Ø§Ù„Ø®Ø¯Ù…Ø§Øª...${NC}"

# Ø®Ø¯Ù…Ø© PostgreSQL
if [ ! -f "$PREFIX/var/service/postgresql/run" ]; then
    echo -e "${BLUE}ðŸ“Š ØªØ«Ø¨ÙŠØª Ø®Ø¯Ù…Ø© PostgreSQL...${NC}"
    pkg install -y postgresql
    mkdir -p $PREFIX/var/service/postgresql
    cat > $PREFIX/var/service/postgresql/run << 'SERVICE'
#!/data/data/com.termux/files/usr/bin/sh
exec postgres -D $PREFIX/var/lib/postgresql 2>&1
SERVICE
    chmod +x $PREFIX/var/service/postgresql/run
fi

# Ø®Ø¯Ù…Ø© Redis
if [ ! -f "$PREFIX/var/service/redis/run" ]; then
    echo -e "${BLUE}ðŸ”´ ØªØ«Ø¨ÙŠØª Ø®Ø¯Ù…Ø© Redis...${NC}"
    pkg install -y redis
    mkdir -p $PREFIX/var/service/redis
    cat > $PREFIX/var/service/redis/run << 'SERVICE'
#!/data/data/com.termux/files/usr/bin/sh
exec redis-server --bind 127.0.0.1 2>&1
SERVICE
    chmod +x $PREFIX/var/service/redis/run
fi

# Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„ØªÙƒÙˆÙŠÙ†
echo -e "${YELLOW}[8/8] Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„ØªÙƒÙˆÙŠÙ†...${NC}"
cat > ~/.marwan-hub/config.toml << 'CONFIG'
[system]
name = "Marwan Hub Factories"
version = "3.0.0"
environment = "production"
data_dir = "~/.marwan-hub"

[api]
host = "0.0.0.0"
port = 8080
workers = 4
enable_cors = true
enable_swagger = true

[database]
type = "sqlite"
path = "~/.marwan-hub/data/marwan.db"
# Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… PostgreSQL:
# type = "postgres"
# url = "postgresql://localhost:5432/marwan_hub"

[cache]
type = "redis"
url = "redis://127.0.0.1:6379"
ttl = 3600

[security]
jwt_secret = "change_this_in_production"
enable_auth = true
rate_limit = 100
rate_window = 60

[mhos]
version = "v2.2"
auto_optimize = true
quality_threshold = 0.85
monitoring_interval = 30

[logging]
level = "info"
file = "~/.marwan-hub/logs/marwan.log"
max_size = 100
max_files = 10

[factories]
education.enabled = true
creative.enabled = true
corporate.enabled = true
technology.enabled = true

[telemetry]
enabled = false
endpoint = "https://telemetry.marwan-hub.com"
CONFIG

# Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
echo ""
echo -e "${GREEN}âœ… ØªÙ… Ø§Ù„ØªØ«Ø¨ÙŠØª Ø¨Ù†Ø¬Ø§Ø­!${NC}"
echo ""
echo "ðŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ«Ø¨ÙŠØª:"
echo "   ðŸ“ Ø§Ù„Ù…Ø³Ø§Ø±: ~/marwan-hub-factories-v3.0.0"
echo "   âš™ï¸  Ø§Ù„ØªÙƒÙˆÙŠÙ†: ~/.marwan-hub/config.toml"
echo "   ðŸ“Š Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ~/.marwan-hub/data"
echo "   ðŸ“ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ~/.marwan-hub/logs"
echo ""
echo "ðŸš€ Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªØ´ØºÙŠÙ„:"
echo "   $ marwan-hub serve           # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù…"
echo "   $ marwan-hub factory list    # Ø¹Ø±Ø¶ Ø§Ù„Ù…ØµØ§Ù†Ø¹"
echo "   $ marwan-hub mhos dashboard  # Ù„ÙˆØ­Ø© MH-OS"
echo "   $ marwan-hub system health   # ÙØ­Øµ Ø§Ù„Ù†Ø¸Ø§Ù…"
echo ""
echo "ðŸ”§ Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø®Ù„ÙÙŠØ©:"
echo "   $ sv-enable postgresql      # ØªØ´ØºÙŠÙ„ PostgreSQL"
echo "   $ sv-enable redis           # ØªØ´ØºÙŠÙ„ Redis"
echo ""
echo "ðŸ“– Ø§Ù„ØªÙˆØ«ÙŠÙ‚:"
echo "   $ marwan-hub docs           # Ø¹Ø±Ø¶ Ø§Ù„ØªÙˆØ«ÙŠÙ‚"
echo ""
echo "ðŸŒ Ø§Ù„ÙˆØµÙˆÙ„ Ø¹Ø¨Ø± Ø§Ù„Ù…ØªØµÙØ­:"
echo "   http://localhost:8080       # ÙˆØ§Ø¬Ù‡Ø© API"
echo "   http://localhost:8080/docs  # Ø§Ù„ØªÙˆØ«ÙŠÙ‚ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ"
echo ""
echo -e "${YELLOW}âš ï¸  Ù…Ù„Ø§Ø­Ø¸Ø©: ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ Ø®Ø¯Ù…Ø§Øª PostgreSQL Ùˆ Redis Ù‚Ø¨Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø¸Ø§Ù…${NC}"
